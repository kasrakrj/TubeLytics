@*
* This template displays the results of a search query for YouTube video descriptions.
*
* Inputs:
* - List of video descriptions matching the search query.
* - Sentiment analysis results or summary statistics for each description.
*
* Expected Outcome:
* - Renders a list of search results with individual video descriptions and sentiment scores.
* - Allows users to see an overview of relevant videos and their sentiment alignment.
*@

@import java.util.Collections
@import scala.jdk.CollectionConverters._
@(searchHistory: java.util.Map[String, java.util.List[entities.Video]], overallSentiment: Map[String, String], individualSentiments: Map[String, String], keyword: String)

@main("YT Lytics") {
<style>
    /* Basic reset and font */
    body, html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #f0f0f5;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        min-height: 100vh;
    }

    /* Welcome title */
    h1 {
        font-size: 2.5em;
        margin: 20px 0;
        color: #333;
        text-align: center;
    }

    /* SearchResult form */
    form {
        display: flex;
        align-items: center;
        margin-bottom: 40px;
    }
    input[type="text"] {
        padding: 10px 15px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 5px 0 0 5px;
        outline: none;
        width: 300px;
    }
    button {
        padding: 10px 20px;
        background-color: #d32f2f;
        border: none;
        color: #fff;
        font-weight: bold;
        border-radius: 0 5px 5px 0;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    button:hover {
        background-color: #b71c1c; /* Hover */
    }

    /* Sentiment display */
    .sentiment {
        font-size: 1.2em;
        color: #555;
        text-align: center;
        margin-bottom: 20px;
    }

    /* SearchResult results list */
    ul {
        list-style-type: none;
        padding: 0;
        width: 80%;
        max-width: 1000px;
        margin: 0 auto;
    }
    li {
        background-color: #fff; /* White background for each item */
        margin: 15px 0;
        padding: 20px;
        border-radius: 10px;
        display: flex;
        align-items: flex-start;
        color: #333;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    li img {
        width: 120px;
        height: 80px;
        border-radius: 8px;
        margin-right: 20px;
    }
    li h3 {
        margin: 0;
        font-size: 1.2em;
        color: #333;
    }
    li a {
        text-decoration: none;
        color: inherit;
    }
    li p {
        margin: 5px 0;
        font-size: 0.9em;
    }
    li p strong {
        color: #444;
    }
</style>

<h1>YT Lytics - Search Results</h1>
<div id="status">Connecting to WebSocket...</div>
<form action="/search" method="GET">
    <input type="text" name="keyword" placeholder="Enter search keywords">
    <button type="submit">Search</button>
</form>

@for((key, videos) <- searchHistory.asScala.toSeq.reverse) {
@defining(key.replaceAll("[^a-zA-Z0-9]", "_")) { safeKey =>
<h2>Search Results for '@key'</h2>
<div class="sentiment" id="sentiment-@safeKey">
    Sentiment for '@key': @overallSentiment.getOrElse(key, "N/A")
</div>

<div>
    <a href="@routes.YoutubeController.wordStats(key)" target="_blank">Search Stats</a>
</div>

<ul class="video-list" id="video-list-@safeKey">
    @for(video <- videos.asScala) {
    <li class="video-item">
        <img src="@video.getThumbnailUrl()" alt="Thumbnail">
        <div>
            <h3>
                <a href="https://www.youtube.com/watch?v=@video.getVideoId()" target="_blank">@video.getTitle()</a>
            </h3>
            <p>@video.getDescription()</p>
            <small>
                Channel:
                <a href="@routes.YoutubeController.channelProfile(video.getChannelId())" target="_blank">@video.getChannelTitle()</a>
            </small>
            <p><a href="@routes.YoutubeController.tags(video.getVideoId())" target="_blank">Tags</a></p>
        </div>
    </li>
    }
</ul>
<hr/>
}
}

<script type="text/javascript">
    var searchKeywords = @Html(play.libs.Json.stringify(play.libs.Json.toJson(searchHistory.keySet().asScala)));

    var socket = new WebSocket('ws://' + window.location.host + '/ws');

    socket.onopen = function() {
        console.log('WebSocket connection established.');
        socket.send(JSON.stringify({ type: 'init', keywords: searchKeywords }));
        document.getElementById('status').textContent = 'Connected to WebSocket.';
    };

    socket.onmessage = function(event) {
        var data = JSON.parse(event.data);

        if (data.type === 'video') {
            var keyword = data.keyword;
            var video = data;
            var safeKey = keyword.replace(/[^a-zA-Z0-9]/g, '_');

            var videoList = document.getElementById('video-list-' + safeKey);

            if (!videoList) {
                createKeywordSection(keyword, safeKey);
                videoList = document.getElementById('video-list-' + safeKey);
            }

            var li = document.createElement('li');
            li.classList.add('video-item');

            var img = document.createElement('img');
            img.src = video.thumbnailUrl;
            img.alt = 'Thumbnail';

            var div = document.createElement('div');

            var h3 = document.createElement('h3');
            var a = document.createElement('a');
            a.href = 'https://www.youtube.com/watch?v=' + video.videoId;
            a.target = '_blank';
            a.textContent = video.title;
            h3.appendChild(a);

            var p = document.createElement('p');
            p.textContent = video.description;

            var small = document.createElement('small');
            small.innerHTML = 'Channel: <a href="/channelProfile/' + video.channelId + '" target="_blank">' + video.channelTitle + '</a>';

            var tagsLink = document.createElement('p');
            var tagsA = document.createElement('a');
            tagsA.href = '/tags/' + video.videoId;
            tagsA.target = '_blank';
            tagsA.textContent = 'Tags';
            tagsLink.appendChild(tagsA);

            div.appendChild(h3);
            div.appendChild(p);
            div.appendChild(small);
            div.appendChild(tagsLink);

            li.appendChild(img);
            li.appendChild(div);

            videoList.insertBefore(li, videoList.firstChild);
        } else if (data.type === 'sentiment') {
            var keyword = data.keyword;
            var sentiment = data.sentiment;
            var safeKey = keyword.replace(/[^a-zA-Z0-9]/g, '_');

            var sentimentElement = document.getElementById('sentiment-' + safeKey);
            if (sentimentElement) {
                sentimentElement.textContent = 'Sentiment for \'' + keyword + '\': ' + sentiment;
            }
        } else if (data.type === 'heartbeat') {
            console.log('Received heartbeat from server.');
        }
    };

    socket.onclose = function() {
        console.log('WebSocket connection closed.');
        document.getElementById('status').textContent = 'WebSocket connection closed.';
    };

    function createKeywordSection(keyword, safeKey) {
        var h2 = document.createElement('h2');
        h2.textContent = "Search Results for '" + keyword + "'";
        document.body.appendChild(h2);

        var sentimentDiv = document.createElement('div');
        sentimentDiv.className = 'sentiment';
        sentimentDiv.id = 'sentiment-' + safeKey;
        sentimentDiv.textContent = "Sentiment for '" + keyword + "': N/A";
        document.body.appendChild(sentimentDiv);

        var statsDiv = document.createElement('div');
        var statsLink = document.createElement('a');
        statsLink.href = '/wordStats/' + encodeURIComponent(keyword);
        statsLink.target = '_blank';
        statsLink.textContent = 'Search Stats';
        statsDiv.appendChild(statsLink);
        document.body.appendChild(statsDiv);

        var ul = document.createElement('ul');
        ul.className = 'video-list';
        ul.id = 'video-list-' + safeKey;
        document.body.appendChild(ul);

        var hr = document.createElement('hr');
        document.body.appendChild(hr);
    }
</script>
}
